generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---

enum Role {
  SUPERADMIN
  ADMIN
  ACCOUNT
  CREATIVE
  TRAFFIC
}

enum JobStatus {
  TODO
  IN_PROGRESS
  DONE
  TENDER
}

enum TimesheetStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AgencyStatus {
  PENDING
  ACTIVE
  REJECTED
}

// --- MODELS ---

model Agency {
  id         String   @id @default(uuid())
  name       String
  slug       String   @unique 
  status     AgencyStatus @default(PENDING)
  contactName String?
  logoUrl    String?
  
  // Fakturačné údaje
  companyId  String?  // IČO
  vatId      String?  // DIČ / IČ DPH
  address    String?  
  email      String?  
  
  users      User[]
  clients    Client[]
  scopes     AgencyScope[]
  positions  AgencyPosition[]
  tenders    Tender[]
  createdAt  DateTime @default(now())

  // Trial & Status
  trialEndsAt       DateTime?
  trialReminderSent Boolean  @default(false)
  isSuspended       Boolean  @default(false)
  
  // Nastavenia schvaľovania
  internalAccountId String?
  internalAccount   User?   @relation("InternalAccount", fields: [internalAccountId], references: [id])
}

model AgencyScope {
  id        String   @id @default(uuid())
  agencyId  String
  agency    Agency   @relation(fields: [agencyId], references: [id])
  name      String   
  @@unique([agencyId, name])
}

model AgencyPosition {
  id        String   @id @default(uuid())
  agencyId  String
  agency    Agency   @relation(fields: [agencyId], references: [id])
  name      String   
  category  String?  @default("Ostatné")
  @@unique([agencyId, name])
}

model User {
  id           String   @id @default(uuid())
  agencyId     String?
  agency       Agency?  @relation(fields: [agencyId], references: [id])
  role         Role
  name         String?
  position     String?
  email        String   @unique
  passwordHash String
  
  // Sadzby
  hourlyRate   Float?   @default(0) 
  costRate     Float?   @default(0) 
  active       Boolean  @default(true)
  
  // Vzťahy
  assignments      JobAssignment[]
  comments         Comment[]
  tenderAssignments TenderAssignment[]
  plannerEntries   PlannerEntry[]
  notifications    Notification[]
  clientNotes      ClientNote[]
  
  // Traffic žiadosti
  requestsSent     ReassignmentRequest[] @relation("RequestBy")
  requestsReceived ReassignmentRequest[] @relation("TargetUser")

  // Agency Management
  managedAgency    Agency[]              @relation("InternalAccount")
}

model Client {
  id         String   @id @default(uuid())
  agencyId   String
  agency     Agency   @relation(fields: [agencyId], references: [id])
  name       String
  priority   Int 
  scope      String?  
  
  contacts   ContactPerson[]
  files      File[]
  campaigns  Campaign[]
  notes      ClientNote[] // Newsfeed
  
  archivedAt DateTime?
  createdAt  DateTime @default(now())
  @@unique([agencyId, name])
}

model ClientNote {
  id        String   @id @default(uuid())
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  text      String
  isPinned  Boolean  @default(false)
  createdAt DateTime @default(now())
}

model ContactPerson {
  id        String  @id @default(uuid())
  clientId  String
  client    Client  @relation(fields: [clientId], references: [id])
  name      String
  email     String?
  phone     String?
  position  String?
}

model Campaign {
  id          String   @id @default(uuid())
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id])
  name        String
  description String?
  jobs        Job[]
  archivedAt  DateTime?
}

model Job {
  id          String   @id @default(uuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id])
  title       String
  status      JobStatus @default(TODO)
  deadline    DateTime
  budget      Float?   @default(0)
  
  assignments JobAssignment[]
  comments    Comment[]
  files       File[]
  budgets     BudgetItem[]
  plannerEntries PlannerEntry[]
  
  archivedAt  DateTime?
  createdAt   DateTime @default(now())
}

model JobAssignment {
  id          String   @id @default(uuid())
  jobId       String
  job         Job      @relation(fields: [jobId], references: [id])
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  roleOnJob   String   
  
  timesheets  Timesheet[]
  comments    Comment[] 
  tenderAssignments TenderAssignment[]
  reassignmentRequests ReassignmentRequest[]
}

model ReassignmentRequest {
  id              String   @id @default(uuid())
  assignmentId    String
  assignment      JobAssignment @relation(fields: [assignmentId], references: [id])
  
  requestByUserId String
  requestByUser   User     @relation("RequestBy", fields: [requestByUserId], references: [id])
  
  targetUserId    String
  targetUser      User     @relation("TargetUser", fields: [targetUserId], references: [id])
  
  reason          String
  status          String   @default("PENDING")
  createdAt       DateTime @default(now())
}

model PlannerEntry {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  jobId     String?  // Voliteľné pre internú prácu
  job       Job?     @relation(fields: [jobId], references: [id])
  
  date      DateTime
  minutes   Int      @default(60)
  title     String?
  isDone    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Timesheet {
  id              String          @id @default(uuid())
  jobAssignmentId String
  jobAssignment   JobAssignment   @relation(fields: [jobAssignmentId], references: [id])
  startTime       DateTime
  endTime         DateTime?       
  durationMinutes Int?
  description     String?         
  status          TimesheetStatus @default(PENDING)
  approvedBy      String?         
  approvedAt      DateTime?
  budgetItem      BudgetItem?
  
  // Stopky a urgencia
  isPaused           Boolean   @default(false)
  lastPauseStart     DateTime?
  totalPausedMinutes Int       @default(0)
  isUrgent           Boolean   @default(false)
}

model BudgetItem {
  id          String   @id @default(uuid())
  jobId       String
  job         Job      @relation(fields: [jobId], references: [id])
  timesheetId String   @unique 
  timesheet   Timesheet @relation(fields: [timesheetId], references: [id])
  hours       Float
  rate        Float
  amount      Float    
  createdAt   DateTime @default(now())
}

model Comment {
  id        String   @id @default(uuid())
  
  // Väzba na Job
  jobId     String?
  job       Job?     @relation(fields: [jobId], references: [id])
  
  // Väzba na JobAssignment
  jobAssignmentId String?
  jobAssignment   JobAssignment? @relation(fields: [jobAssignmentId], references: [id])

  // Väzba na Tender
  tenderId  String?
  tender    Tender?  @relation(fields: [tenderId], references: [id], onDelete: Cascade) 
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  text      String
  createdAt DateTime @default(now())
}

model File {
  id         String   @id @default(uuid())
  name       String?  @default("")
  
  jobId      String?  
  job        Job?     @relation(fields: [jobId], references: [id])
  
  clientId   String?
  client     Client?  @relation(fields: [clientId], references: [id])
  
  tenderId   String?
  tender     Tender?  @relation(fields: [tenderId], references: [id], onDelete: Cascade) 
  
  uploadedBy String
  fileUrl    String
  fileType   String
  createdAt  DateTime @default(now())
}

model Tender {
  id          String    @id @default(uuid())
  agencyId    String
  agency      Agency    @relation(fields: [agencyId], references: [id])
  title       String
  description String?   // Brief
  status      JobStatus @default(TODO) 
  deadline    DateTime
  budget      Float?    @default(0)
  isConverted Boolean   @default(false)
  
  assignments TenderAssignment[]
  comments    Comment[]
  files       File[]
  createdAt   DateTime  @default(now())
}

model TenderAssignment {
    id          String   @id @default(uuid())
    tenderId    String
    tender      Tender    @relation(fields: [tenderId], references: [id], onDelete: Cascade)
    
    userId      String
    user        User     @relation(fields: [userId], references: [id])
    
    roleOnJob   String

    jobAssignmentId String? 
    jobAssignment   JobAssignment? @relation(fields: [jobAssignmentId], references: [id])
}

model EmailTemplate {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String
  subject     String
  body        String
  description String?
  updatedAt   DateTime @updatedAt
}